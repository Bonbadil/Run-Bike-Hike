"use strict;";if(navigator.mozApps){var checkIfInstalled=navigator.mozApps.getSelf();checkIfInstalled.onsuccess=function(){if(checkIfInstalled.result){var e=document.querySelector("#installation-instructions");e&&(e.style.display="none")}else{var t=document.querySelector("#install"),n=location.href.substring(0,location.href.lastIndexOf("/"))+"/manifest.webapp";console.log("manifestURL",n),t.className="show-install",t.onclick=function(){var e=navigator.mozApps.install(n);e.onsuccess=function(){t.style.display="none"},e.onerror=function(){alert("Install failed\n\n:"+e.error.name)}}}}}else console.log("Open Web Apps not supported");var reload=document.querySelector("#reload");reload&&(reload.onclick=function(){location.reload(!0)});var HomeView=function(){function e(){document.getElementById("message-area").removeChild(document.getElementById("spinner"))}function t(e,t){document.getElementById("message").className="behind hidden",document.getElementById("home-lat").innerHTML=Config.userLatitude(e.coords.latitude),document.getElementById("home-lon").innerHTML=Config.userLongitude(e.coords.longitude);var n=Config.userSmallDistance(e.coords.altitude);document.getElementById("home-alt").innerHTML=n.v,document.getElementById("alt-unit").innerHTML="("+n.u+")";var n=Config.userSmallDistance(e.coords.accuracy.toFixed(0));document.getElementById("home-acc").innerHTML="&#177; "+n.v,document.getElementById("acc-unit").innerHTML="("+n.u+")",document.getElementById("home-acc").className=e.coords.accuracy>25?"new-line home-alt align-center text-big text-thinner bad-signal":"new-line home-alt align-center text-big text-thin";var n=Config.userDistance(t);document.getElementById("home-dist").innerHTML=n.v,document.getElementById("dist-unit").innerHTML="("+n.u+")";var n=Config.userSpeed(e.coords.speed);document.getElementById("home-speed").innerHTML=n.v,document.getElementById("speed-unit").innerHTML="("+n.u+")",document.getElementById("msg").innerHTML="",document.getElementById("home-dir").innerHTML=e.coords.heading>0?e.coords.heading.toFixed(0):"--"}function n(){document.getElementById("home-acc").innerHTML="??",document.getElementById("home-lat").innerHTML="??",document.getElementById("home-lon").innerHTML="??",document.getElementById("home-alt").innerHTML="??",document.getElementById("home-dist").innerHTML="??",document.getElementById("home-speed").innerHTML="??",document.getElementById("msg").innerHTML=_("error-positon",{Error:Error}),document.getElementById("spinner")&&e()}return{updateInfos:t,displayError:n}}(),InfosView=function(){var e=function(e,n){console.log("showing: ",n),document.getElementById("infos-dist").innerHTML=1e3>n?Controller.userSmallDistance(n):Controller.userDistance(n),document.getElementById("infos-speed").innerHTML=Controller.userSpeed(e.coords.speed),document.getElementById("infos-alt").innerHTML=Controller.userSmallDistance(e.coords.altitude),document.getElementById("infos-acc").innerHTML="&#177;"+Controller.userSmallDistance(e.coords.accuracy),document.getElementById("infos-acc").className=e.coords.accuracy>30?"align-right bold bad-signal":"align-right bold",t(e.coords)},t=function(e){if(compass=document.getElementById("infos-compass"),e.heading>0){opacity=1,compass.src="img/compass.png";var t=360-e.heading.toFixed(0);compass.style.transform="rotate("+t+"deg)"}else compass.src="img/compass_inactive.png",opacity=1;compass.style.opacity=opacity};return{updateInfos:e}}(),TracksView=function(){function e(e,t){var a=document.getElementById("tracks-list");if(console.log("list.childNodes",a.childNodes),console.log("inTracks",e),0===e.length)n();else{var r=[];r=e;for(var i=r.length-1;i>=0;i--)o(r[i],t)}document.getElementById("list-spinner").className="behind hidden"}function t(){if(document.getElementById("tracks-list").hasChildNodes()){a("tracks-list");var e=document.createElement("li");e.className="ontop",e.id="list-spinner";var t='<div class="align-center top40"><progress id="spinner"></progress></div>';e.innerHTML=t,document.getElementById("tracks-list").appendChild(e)}}function n(){var e=document.createElement("p");e.className="empty-tracks",e.innerHTML=_("empty-list"),document.getElementById("tracks-list").appendChild(e)}function o(e,t){var n=document.createElement("li");n.className="it-track";var o=document.createElement("a"),a='<p><span class="align-left clipped">'+e.name+"</span>",r=Config.userDistance(e.distance);a=a+'<span class="align-right text-thin">'+r.v+r.u+"</span></p>",a=a+'<p class="new-line"><span class="align-left text-thin">'+Config.userDate(e.date)+"</span>";var i=e.duration/6e4;a=a+'<span class="align-right text-thin">'+i.toFixed()+"min</span></p>",o.innerHTML=a,n.appendChild(o),document.getElementById("tracks-list").appendChild(n),o.addEventListener("click",function(){document.getElementById("views").showCard(4),t(e)})}function a(e){var t=document.getElementById(e).childNodes;for(console.log("d",t),i=0;i=t.length-1;i++)console.log("remove element "+i+" "+t[i]),document.getElementById(e).removeChild(t[i])}return{display:e,reset:t}}(),TrackView=function(){function e(e,t){console.log("inTrack in display",e),document.getElementById("trk-date").innerHTML="",document.getElementById("trk-dist").innerHTML="",document.getElementById("trk-dur").innerHTML="",document.getElementById("map-img").src="";var n=document.getElementById("tr-name");n.innerHTML=e.name,document.getElementById("trk-date").innerHTML=Config.userDate(e.date);var r=Config.userDistance(e.distance);document.getElementById("trk-dist").innerHTML=r.v+r.u;var s=e.duration/6e4;document.getElementById("trk-dur").innerHTML=s.toFixed()+" min";var c=e;for(console.log("t",c),c.min_alt=0,c.max_alt=0,c.max_speed=0,c.min_speed=0,c.av_speed=0,c.start=null,c.end=null,i=0;i<c.data.length;i++){var l=c.data[i],d=parseInt(l.altitude,10),m=parseInt(l.speed,10);(0===c.min_alt||d<c.min_alt)&&(c.min_alt=d),(0===c.max_alt||d>c.max_alt)&&(c.max_alt=d),(0===c.max_speed||m>c.max_speed)&&(c.max_speed=m);var g=new Date(c.data[i].date).getTime();(null===c.start||g<c.start)&&(c.start=g),(null===c.end||g>c.end)&&(c.end=g),c.av_speed=c.av_speed+m}console.log("t.av_speed",c.av_speed),c.av_speed=c.av_speed/c.data.length,console.log("t.max_speed",c.max_speed);var r=Config.userSpeed(c.max_speed);document.getElementById("trk-max-speed").innerHTML=r.v+r.u;var r=Config.userSpeed(c.av_speed);document.getElementById("trk-av-speed").innerHTML=r.v+r.u;var r=Config.userSmallDistance(c.max_alt);document.getElementById("trk-max-alt").innerHTML=r.v+r.u;var r=Config.userSmallDistance(c.min_alt);if(document.getElementById("trk-min-alt").innerHTML=r.v+r.u,c.map){console.log("map exist");var f=document.getElementById("map-img");f.width=u,f.src=window.URL.createObjectURL(c.map),f.onload=function(){window.URL.revokeObjectURL(this.src)},document.querySelector("#map-text").classList.add("hidden"),document.querySelector("#track-spinner").classList.add("hidden"),f.classList.remove("hidden")}else{console.log("map does not exist");{a(e,t)}}o(c)}function n(e){console.log("updating"),document.getElementById("tr-name").innerHTML=e}function o(e){var t=e.data,n=0,o=0,a=0;for(i=0;i<t.length;i++)parseInt(t[i].altitude,10)>o&&(o=parseInt(t[i].altitude,10)),parseInt(t[i].altitude,10)<a&&(a=parseInt(t[i].altitude,10)),parseInt(t[i].vertAccuracy,10)>n&&(n=parseInt(t[i].vertAccuracy,10)),n/=2;var l=Config.userSpeedInteger(e.max_speed),d=Config.userSpeedInteger(e.min_speed),g=o-a;g+=g/3;var f=l-d;f=2*f;var k=parseInt(g/4,10),I=parseInt(f/4,10);console.log("speed",f+"-"+I),console.log("alt",g+"-"+k);var b=r("graphs-canvas",g,k,f,I),T=parseInt(t.length/(u-p-5),10);0===T?T=1:T*=v,b.fillStyle=w;var L=Config.userSmallDistance(null);b.fillText(_("altitude")+" ("+L.u+")",p+50,8),b.fillStyle=E;var L=Config.userSpeed(null);if(b.fillText(_("speed")+" ("+L.u+")",p+50,20),b.stroke(),t.length<=v)var B=t.length;else var B=t.length/v;for(i=0;i<t.length;i+=B){i=parseInt(i,10);var M=new Date(t[i].date).getHours()+":"+new Date(t[i].date).getMinutes();b.textAlign="center",b.fillStyle="gray",b.fillText(M,s(i,t),m-h+27),b.beginPath(),b.moveTo(s(i,t),m-h+15),b.lineTo(s(i,t),m-h+20),b.stroke()}for(b.strokeStyle=w,b.lineWidth=y,b.beginPath(),b.moveTo(s(0,t),c(t[0].altitude,g)),i=1;i<t.length;i+=T){var x=s(i,t);b.lineTo(x,c(t[i].altitude,g))}b.lineTo(x,m-h),b.lineTo(s(0,t),m-h),b.lineTo(s(0,t),c(t[0].altitude,g)),b.fillStyle=C,b.fill(),b.stroke(),b.strokeStyle=E,b.globalAlpha=1,b.lineWidth=y,b.beginPath();var D=Config.userSpeedInteger(t[0].speed);for(b.moveTo(s(0,t),c(D,f)),i=1;i<t.length;i+=T){var D=Config.userSpeedInteger(t[i].speed),x=s(i,t);b.lineTo(x,c(D,f))}b.lineTo(x,m-h),b.lineTo(s(0,t),m-h),b.lineTo(s(0,t),c(Config.userSpeedInteger(t[0].speed),f)),b.fillStyle=S,b.fill(),b.stroke(),b.closePath()}function a(e,t){var n,o,a,r;for(C=0;C<e.data.length;C++){var i={lat:e.data[C].latitude/1,lon:e.data[C].longitude/1};(void 0===n||n>i.lat)&&(n=i.lat),(void 0===a||a<i.lat)&&(a=i.lat),(void 0===o||o>i.lon)&&(o=i.lon),(void 0===r||r<i.lon)&&(r=i.lon)}var s={lon:o,lat:a},c={lon:r,lat:n},m=l(s.lat,s.lon,c.lat,s.lon),p=l(s.lat,s.lon,s.lat,c.lon),h=p>m?p:m;if(200>h&&(h=200),s=d(s,h*-.1,h*-.1),c=d(c,.1*h,.1*h),m>p&&(s=d(s,(m-p)/-2,0),c=d(c,(m-p)/2,0),m=l(s.lat,s.lon,c.lat,s.lon),p=l(s.lat,s.lon,s.lat,c.lon),h=p>m?p:m),0!==h){var v=100,y="0x0AFF00",k="&polyline=color:"+y+"|width:3|",I=0;if(e.data.length>v){var w=parseInt(e.data.length/v,10);w*e.data.length>v&&(w+=1)}else var w=1;for(var C=0;C<e.data.length;C+=w)k=C===e.data.length-1?k+e.data[C].latitude+","+e.data[C].longitude:k+e.data[C].latitude+","+e.data[C].longitude+",",I++;var E="&bestfit="+s.lat+","+s.lon+","+c.lat+","+c.lon,S="&size="+g+","+f,b="&type=map&imagetype=jpeg",T="http://www.mapquestapi.com/staticmap/v4/getmap?key=Fmjtd%7Cluur21u720%2Cr5%3Do5-90tx9a&",L=T+S+b+E+k;document.getElementById("map-img").width=u,document.getElementById("map-img").onload=function(){document.querySelector("#map-text").classList.add("hidden"),document.querySelector("#track-spinner").classList.add("hidden"),document.querySelector("#map-img").classList.remove("hidden")};var B,M=new XMLHttpRequest;M.open("GET",L,!0),M.responseType="blob",M.addEventListener("load",function(){if(200===M.status){B=M.response;var n=window.URL||window.webkitURL,o=n.createObjectURL(B);document.getElementById("map-img").src=o,e.map=B,t(e)}},!1),M.send()}}function r(e,n,o,a,r){var i=document.getElementById(e),s=i.getContext("2d");s.clearRect(0,0,u-5,m),i.setAttribute("width",u-5),i.setAttribute("height",m),s.fillStyle=I,s.font=k,s.textAlign="right",s.textBaseline="middle";var l=0,d=0,g=0,f=0;for(t=0;4>t;t++){var v=Config.userSmallDistance(parseInt(d,10));s.fillStyle=w,s.fillText(v.v,p-10,c(l,n)-6),s.fillStyle=E,s.fillText(f,p-10,c(g,a)+6),s.beginPath(),s.moveTo(p,c(l,n)),s.lineTo(u-5,c(l,n)),s.lineWidth=.2,s.strokeStyle="black",s.stroke(),l+=o,d+=o,g+=r,f+=r,console.log("2-speed.v",speed.v)}return s.beginPath(),s.moveTo(p,m-h+15),s.lineTo(u-5,m-h+15),s.lineWidth=.1,s.strokeStyle="black",s.stroke(),s}function s(e,t){return(u-p-5)/t.length*e+p}function c(e,t){return m-(m-h)/t*e-h}function l(e,t,n,o){var a=6371e3,r=e*(Math.PI/180),i=t*(Math.PI/180),s=n*(Math.PI/180),c=o*(Math.PI/180),l=s-r,d=c-i,u=Math.sin(l/2)*Math.sin(l/2)+Math.cos(r)*Math.cos(s)*Math.sin(d/2)*Math.sin(d/2),m=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u));return a*m}function d(e,t,n){var o=6371e3,a=e.lat*(Math.PI/180),r=e.lon*(Math.PI/180),i=Math.sin(Math.PI/2-a)*o,s=0==i?0:t/i,c=n/o;return a-=c,r+=s,{lat:a/(Math.PI/180),lon:r/(Math.PI/180)}}var u=parseInt(window.innerWidth,10),m=parseInt(2*u/3,10),g=648,f=432,p=35,h=30,v=5,y=2,k="8pt bold 'Fira Sans',sans-serif",I="#333",w="#008000",C="rgba(0,128,0,0.3)",E="#4169E1",S="rgba(65,105,225, 0.3)";return{display:e,updateName:n}}(),utils=this.utils||{};utils.status=function(){function e(){null!==l&&(window.clearTimeout(l),l=null)}function t(t,n){if(e(),c.innerHTML="","string"==typeof t)c.textContent=t;else try{c.appendChild(t)}catch(a){console.error("DOMException: "+a.message)}s.classList.remove("hidden"),s.classList.add("onviewport"),l=window.setTimeout(o,n||d)}function n(t){var n="status-showed";"hide"===t.animationName&&(e(),s.classList.add("hidden"),n="status-hidden"),window.dispatchEvent(new CustomEvent(n))}function o(){s.classList.remove("onviewport")}function a(){s.removeEventListener("animationend",n),document.body.removeChild(s),e(),s=c=null}function r(){s=document.createElement("section"),s.setAttribute("role","status"),s.classList.add("hidden"),c=document.createElement("p"),s.appendChild(c),document.body.appendChild(s),s.addEventListener("animationend",n)}function i(){s||r()}var s,c,l,d=2e3;return"complete"===document.readyState?i():document.addEventListener("DOMContentLoaded",function u(){document.removeEventListener("DOMContentLoaded",u),i()}),{init:i,show:t,hide:o,destroy:a,setDuration:function(e){d=e||d}}}();var Chrono=function(){function e(){return s&&(d=(new Date).getTime(),c+=d-l,s=!1),o(),!0}function t(e){return e&&(r=e),r.textContent=a(),i=window.setTimeout(t,10),!0}function n(){return console.log("demarrerChrono;"),s||(l=(new Date).getTime(),s=!0,console.log("chrono_demarre: ",s)),!0}function o(){return s||(c=0,l=0,d=0),!0}function a(){var e;s?(d=(new Date).getTime(),e=new Date(c+(d-l))):e=new Date(c);var t=parseInt(e.getHours())-1,n=e.getMinutes(),o=e.getSeconds();return 10>o&&(o="0"+o),10>n&&(n="0"+n),t+":"+n+":"+o}var r,i,s=!1,c=0,l=0,d=0;return{start:n,stop:e,reset:o,load:t}}(),Config=function(){function e(e,t){e=t}function t(e){var t={};return null===e||0>e||isNaN(e)?(Config.CONFIG.speed===u&&(t.u="mph"),Config.CONFIG.speed===d&&(t.u="km/h"),t.v="--",t):Config.CONFIG.speed===u?(t.v=(2.237*e).toFixed(0),t.u="MPH",t):Config.CONFIG.speed===d?(t.v=(3.6*e).toFixed(0),t.u="km/h",t):(t.v=e,t.u="m/s",t)}function n(e){return null===e||0>e||isNaN(e)?null:Config.CONFIG.speed===u?(2.237*e).toFixed(0):Config.CONFIG.speed===d?(3.6*e).toFixed(0):e}function o(e){return minutes=60*(e-Math.floor(e)),seconds=60*(minutes-Math.floor(minutes)),Math.floor(e)+"°"+(10>minutes?"0":"")+Math.floor(minutes)+"'"+(10>seconds?"0":"")+seconds.toFixed(2)+'"'}function a(e){return Config.CONFIG.position===g?e:Config.CONFIG.position===m?(e>0?"N":"S")+" "+i(Math.abs(e)):this.userDegree(Math.abs(e))+(e>0?"N":"S")}function r(e){return Config.CONFIG.position===g?e:Config.CONFIG.position===m?(e>0?"E":"W")+" "+i(Math.abs(e)):this.userDegree(Math.abs(e))+(e>0?"E":"W")}function i(e){return minutes=60*(e-Math.floor(e)),Math.floor(e)+"°"+(10>minutes?"0":"")+minutes.toFixed(3)+"'"}function s(e,t){var n={};return null===e||0>e&&!t?(Config.CONFIG.distance===u&&(n.u="ft"),Config.CONFIG.distance===d&&(n.u="m"),n.v="--",n):Config.CONFIG.distance===u?(n.v=(3.2808*e).toFixed(0),n.u="ft",n):Config.CONFIG.distance===d?(n.v=(1*e).toFixed(0),n.u="m",n):(n.v=e,n.u="m",n)}function c(e,t){var n={};return null===e||0>e&&!t?(Config.CONFIG.distance===u&&(n.u="miles"),Config.CONFIG.distance===d&&(n.u="km"),n.v="--",n):Config.CONFIG.distance===d?(tmp=e/1e3,n.v=tmp.toFixed(tmp>=10?0:1),n.u="km",n):Config.CONFIG.distance===u?(tmp=e/1609.344,n.v=tmp.toFixed(tmp>=10?0:1),n.u="miles",n):(n.v=e,n.u="m",n)}function l(e){{var t=new Date(e),n=t.getFullYear(),o=t.getMonth()+1,a=t.getDate();t.getHours(),t.getMinutes(),t.getSeconds()}10>o&&(o="0"+o.toString()),10>a&&(a="0"+a.toString());var r=a+"/"+o+"/"+n;return r}var d="0",u="1",m="1",g="2";return _generate_x_axis=function(e,t){var n=[];length=t-e,align=3e5,maxLines=6,length/align>maxLines&&(align=6e5,console.log("10 minutes")),length/align>maxLines&&(align=9e5,console.log("15 minutes")),length/align>maxLines&&(align=18e5,console.log("30 minutes")),length/align>maxLines&&(align=36e5,console.log("60 minutes")),dateobj=new Date(e),startOfDay=Date.parse(dateobj.getFullYear()+" - "+dateobj.getMonth()+" - "+dateobj.getDate()),alignedStart=e+(align-(e-startOfDay)%align);var o=0,a=new Date;for(time=alignedStart;t>time;time+=align)n[o++]={time:time,label:config.format_time(new Date(time+-60*a.getTimezoneOffset()*1e3),!0)};return n},_generate_y_axis=function(e,t,n){var o=[];range=t-e,align=1/n,maxLines=9,alignArr=new Array(2,5,10,20,25,50,100,150,200,250,500,1e3);for(var a=0;a<alignArr.length&&range/align>maxLines;a++)align=alignArr[a]/n;for(alignedStart=e%align===0?e:e+(align-e%align),a=0,val=alignedStart;t>val;val+=align)o[a++]={value:val,label:(val*n).toFixed(0)};return o},_generate_alt_axis=function(e,t){return unit="m",unitMultiply=1,this.units===u&&(unitMultiply=3.2808,unit="ft"),config.generate_x_axis(e,t,unitMultiply,unit)},_format_time=function(e,t){return strRes="NA",secs=e.getSeconds(),strSecs=secs>9?String(secs):"0"+String(secs),mins=e.getMinutes(),strMins=mins>9?String(mins):"0"+String(mins),hrs=e.getHours(),strHrs=hrs>9?String(hrs):"0"+String(hrs),t?strHrs+":"+strMins:strHrs+":"+strMins+":"+strSecs},{change:e,userSpeed:t,userSpeedInteger:n,userDegree:o,userLatitude:a,userLongitude:r,userSmallDistance:s,userDistance:c,userDate:l}}(),Share=function(){function e(e,t,n,o){console.log("saving to local :-(");var a=navigator.getDeviceStorage("sdcard"),r=new Blob([e],{type:"plain/text"}),i=a.addNamed(r,"/sdcard/rbh/"+t);i.onsuccess=function(){n("success on saving file ",this.result)},i.onerror=function(){"NoModificationAllowedError"===this.error.name?(console.warn("Unable to write the file: ","File already exists"),o("Unable to write the file: File already exists")):"SecurityError"===this.error.name?(console.warn("Unable to write the file: ","Permission Denied"),o("Unable to write the file: Permission Denied")):(console.warn("Unable to write the file: ",this.error.name),o("Unable to write the file: "+this.error.name))}}function t(e,t){var n=new Blob([t],{type:"text/plain"}),o=e.name+".gpx",a=new MozActivity({name:"new",data:{type:"mail",filenames:[o],blobs:[n]}});a.onsuccess=function(){console.log("email send with success:",this.result)},a.onerror=function(){console.log("email not send:",this.error)}}function n(){}return{toLocal:e,toEmail:t,toTwitter:n}}(),DB=function(){function e(e,t){if("function"==typeof e){var n=window.indexedDB.open(d,u);n.onsuccess=function(){db=n.result,e(n.result),db.onabort=function(){db.close(),db=null}},n.onerror=function(e){console.error("error on initiate DB: ",e.target.error.name),t(e.target.error.name),g_error=!0},n.onupgradeneeded=function(){var e=n.result.createObjectStore(m,{keyPath:"id",autoIncrement:!0});e.createIndex("trackid","trackid",{unique:!0});var e=n.result.createObjectStore(g,{keyPath:"key"});e.createIndex("key","key",{unique:!0}),e.createIndex("value","value",{unique:!1})}}else t("initiate() successCallback should be a function")}function t(e,t,n){if("function"==typeof e){var o=db.transaction(m,"readwrite");o.oncomplete=function(){},o.onerror=function(e){t(e.error.name)};var a=o.objectStore(m),r=a.add(n);r.onsuccess=function(){e(n.name)},r.onerror=function(){t(r.error.name)}}else t("addTrack successCallback should be a function")}function n(e,t){if("function"==typeof e){var n=[],o=db.transaction("tracks"),a=o.objectStore("tracks"),r=a.openCursor();r.onsuccess=function(t){var o=t.target.result;o?(n.push(o.value),o.continue()):e(n)},r.onerror=function(e){console.error("get_tracks store.openCursor error: ",e.error.name)}}else t("getTracks successCallback should be a function")}function o(){var e=window.indexedDB.deleteDatabase(d);e.onerror=function(e){console("reset error: ",e.error.name)},e.onsuccess=function(){console.log(d+" deleted successful !")}}function a(e,t,n){if("function"==typeof e){var o=db.transaction(m,"readwrite");o.oncomplete=function(){console.log("delete_track transaction completed !")},o.onerror=function(){console.error("delete_track transaction error: ",o.error.name),t(x.error.name)};var a=o.objectStore(m),r=a.delete(n.id);r.onsuccess=function(){console.log("track_delete store store.delete successful"),e(n.name)},r.onerror=function(){console.error("track_delete store store.delete error: ",r.error.name),t(r.error.name)}}else t("deleteTrack successCallback should be a function")}function r(e,t){if("function"==typeof e){var n=[],o=db.transaction(g),a=o.objectStore(g),r=a.openCursor();r.onsuccess=function(t){var o=t.target.result;if(o)n.push(o.value),o.continue();else{0===n.length&&(console.log("no config found, loading the default one !"),n=f,c());for(var a={},r=0;r<n.length;r++)a[n[r].key]=n[r].value;console.log("loaded settings are:",a),e(a)}},r.onerror=function(e){console.error("getConfig store.openCursor error: ",e.error.name)}}else t("getConfig() successCallback should be a function")}function i(e,t,n){if("function"==typeof e){var o=db.transaction(m,"readwrite"),a=o.objectStore(m),r=a.get(n.id);r.onsuccess=function(){var e=a.put(n);e.onsuccess=function(){console.log("successfully updated")},e.onerror=function(e){console.log("failure on saving map"),t(e.error.name)}}}else t("addTrack successCallback should be a function")}function s(e,t,n){if("function"==typeof e){var o=db.transaction(m,"readwrite"),a=o.objectStore(m),r=a.get(n.id);r.onsuccess=function(){var o=a.put(n);o.onsuccess=function(){console.log("successfully updated"),e()},o.onerror=function(e){console.log("failure on updating"),t(e.error.name)}}}else t("addTrack successCallback should be a function")}function c(){console.log("saving default config");var e=db.transaction(g,"readwrite");e.oncomplete=function(){},e.onerror=function(){errorCallback(x.error.name)};for(var t=e.objectStore([g]),n=0;n<f.length;n++){var o=t.add(f[n]);o.onsuccess=function(){},o.onerror=function(){}}}function l(e,t,n,o){if("function"==typeof e){var a=db.transaction(g,"readwrite"),r=a.objectStore(g),i=r.get(n);console.log("req",i),i.onsuccess=function(){i.result.value=o,console.log("req.result",i.result);var n=r.put(i.result);console.log("req2",n),n.onsuccess=function(){console.log("successfully updated"),e()},n.onerror=function(e){t(e.error.name)}},i.onerror=function(e){t(e.error.name)}}else t("updateConfig successCallback should be a function")}window.indexedDB=window.shimIndexedDB&&window.shimIndexedDB.__useShim();var d="RunBikeHike",u=1,m="tracks",g="settings",f=[{key:"screen",value:!1},{key:"language",value:"en"},{key:"distance",value:"0"},{key:"speed",value:"0"},{key:"position",value:"0"}];return{initiate:e,addTrack:t,getTracks:n,deleteTrack:a,reset_app:o,getConfig:r,updateConfig:l,saveMap:i,updateTrack:s}}(),Tracks=function(){function e(){c={};var e=new Date;c.date=e.toISOString(),s=e.getTime(),c.id=c.date;var t=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),a=e.getHours(),r=e.getMinutes(),i=e.getSeconds();return 10>n&&(n="0"+n.toString()),10>o&&(o="0"+o.toString()),10>a&&(a="0"+o.toString()),10>r&&(r="0"+o.toString()),10>i&&(i="0"+o.toString()),c.name="TR-"+t+n+o+"-"+a+r+i,c.duration=0,c.distance=0,c.map="",c.data=[],nb_point=0,console.log("current_track",c),c}function t(e,t,n){c.data.push(e),c.distance=t,c.duration=n,nb_point=1}function n(e,t){return null!=d&&(l+=i(d,u,e,t)),d=e,u=t,l}function o(e){return e-s}function a(){return c}function r(){l=0}function i(e,t,n,o){var a=e*(Math.PI/180),r=t*(Math.PI/180),i=n*(Math.PI/180),s=o*(Math.PI/180),c=i-a,l=s-r,d=Math.sin(c/2)*Math.sin(c/2)+Math.cos(a)*Math.cos(i)*Math.sin(l/2)*Math.sin(l/2),u=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),m=6371e3;return m*u}var s,c={},l=0,d=null,u=null;return{open:e,addNode:t,getDuration:o,getDistance:n,reset:r,close:a}}(),ExportTrack=function(){var e=function(e){var t=e.name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),n="";n+="<?xml version='1.0' encoding='UTF-8'?>\n",n+="<gpx version='1.1'\n",n+="creator='Run, Bike, Hike - https://github.com/nicodel/Run-Bike-Hike'\n",n+="xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'\n",n+="xmlns='http://www.topografix.com/GPX/1/1'\n",n+="xsi:schemaLocation='http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd'>\n",n+="<metadata>\n",n+="<author><name>Nicolas Delebecque</name><link href='https://github.com/nicodel/'></link></author>",n+="<name>"+t+"</name>",n+="</metadata>",n+="<trk>\n<name>"+t+"</name>\n<trkseg>\n";for(var o=0;o<e.data.length;o++){var a=e.data[o];n+="<trkpt lat='"+a.latitude+"' lon='"+a.longitude+"'>\n",n+="	<time>"+a.date+"</time>\n",n+=a.altitude&&"null"!=a.altitude?"	<ele>"+a.altitude+"</ele>\n":"",n+=a.speed>=0?"	<speed>"+a.speed+"</speed>\n":"",n+=a.accuracy>0?"	<hdop>"+a.accuracy+"</hdop>\n":"",n+=a.vertAccuracy>0?"	<vdop>"+a.vertAccuracy+"</vdop>\n":"",n+="</trkpt>\n"}return n+="</trkseg>\n</trk>\n",n+="</gpx>\n"},t=function(e){e.name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};return{toGPX:e,toSummary:t}}();document.querySelector("#btn-tracks").addEventListener("click",function(){Controller.displayTracks(),document.getElementById("views").showCard(3)}),document.querySelector("#btn-start-stop").addEventListener("click",function(){Controller.toggleWatch()}),document.querySelector("#btn-settings").addEventListener("click",function(){document.getElementById("views").showCard(0)}),document.querySelector("#btn-confirm-stop").addEventListener("click",function(){document.getElementById("views").showCard(1),Controller.stopWatch()}),document.querySelector("#btn-cancel-stop").addEventListener("click",function(){document.getElementById("views").showCard(1)}),document.getElementById("stop-form-confirm").onsubmit=function(){return!1},document.querySelector("#screen").onchange=function(){Controller.savingSettings("screen",this.checked),Controller.toggleScreen(this.checked),console.log("this.checked",this.checked)},document.querySelector("#language").onchange=function(){var e=document.querySelector("#language"),t=this.selectedIndex;Controller.savingSettings("language",e[t].value),Controller.changeLanguage(e[t].value),document.webL10n.setLanguage(e[t].value)},document.querySelector("#distance").onchange=function(){var e=document.querySelector("#distance"),t=this.selectedIndex;Controller.savingSettings("distance",e[t].value),Controller.changeDistance(e[t].value)},document.querySelector("#speed").onchange=function(){var e=document.querySelector("#speed"),t=this.selectedIndex;Controller.savingSettings("speed",e[t].value),Controller.changeSpeed(e[t].value)},document.querySelector("#position").onchange=function(){var e=document.querySelector("#position"),t=this.selectedIndex;Controller.savingSettings("position",e[t].value),Controller.changePosition(e[t].value)},document.querySelector("#btn-settings-back").addEventListener("click",function(){document.getElementById("views").showCard(1)}),document.querySelector("#btn-tracks-back").addEventListener("click",function(){document.getElementById("views").showCard(1)}),document.querySelector("#btn-track-back").addEventListener("click",function(){Controller.displayTracks(),document.getElementById("views").showCard(3)}),document.querySelector("#btn-delete").addEventListener("click",function(){document.getElementById("views").showCard(5)}),document.querySelector("#btn-rename").addEventListener("click",function(){console.log("renaming"),document.querySelector("#input-rename").value=Controller.getTrackName(),document.getElementById("views").showCard(6)}),document.querySelector("#btn-cancel-rename").addEventListener("click",function(){document.getElementById("views").showCard(4)}),document.querySelector("#btn-confirm-rename").addEventListener("click",function(){document.getElementById("views").showCard(4);var e=document.querySelector("#input-rename");Controller.renameTrack(e.value)}),document.querySelector("#btn-clear-rename").addEventListener("click",function(){document.querySelector("#input-rename").value=""}),document.getElementById("rename-form").onsubmit=function(){return!1},document.querySelector("#btn-clear-rename").addEventListener("mousedown",function(e){e.preventDefault()}),document.querySelector("#btn-share").addEventListener("click",function(){console.Log("exporting"),document.getElementById("views").showCard(7),document.querySelector("#select-share").value="local"}),document.querySelector("#btn-cancel-share").addEventListener("click",function(){document.getElementById("views").showCard(4)}),document.querySelector("#btn-confirm-share").addEventListener("click",function(){var e,t=!1;document.querySelector("#toggle-share-file").value?e=!0:document.querySelector("#toggle-share-summary").value&&(t=!0);var n=document.querySelector("#select-share").value;console.log("ready to share",n),document.getElementById("views").showCard(4),Controller.shareTrack(e,t,n)}),document.getElementById("share-form").onsubmit=function(){return!1},document.querySelector("#btn-cancel-delete").addEventListener("click",function(){document.getElementById("views").showCard(4)}),document.querySelector("#btn-confirm-delete").addEventListener("click",function(){document.getElementById("views").showCard(3),Controller.deleteTrack()}),document.getElementById("del-form-confirm").onsubmit=function(){return!1},document.querySelector("#dev-import").addEventListener("click",function(){Controller.importForDev()});var Controller=function(){function e(){DB.initiate(t,n),navigator.geolocation&&(U=navigator.geolocation.watchPosition(function(e){o(e)},function(e){a(e)},{enableHighAccuracy:!0,timeout:1/0,maximumAge:0}))}function t(){DB.getConfig(l,d)}function n(e){utils.status.show(e)}function o(e){z?s(e):HomeView.updateInfos(e,null)}function a(e){console.log("error:",e),z?c(e):HomeView.displayError(e)}function r(){z?document.getElementById("views").showCard(2):(z=!0,Chrono.load(document.getElementById("home-chrono")),Chrono.start(),current_track=Tracks.open(),nb_point=0,document.getElementById("btn-start-stop").className="danger big",document.getElementById("btn-start-stop").textContent=_("stop"))}function i(){Chrono.stop(),Tracks.reset(),Chrono.reset();var e=Tracks.close();z=!1,console.log("track is",e),0===e.data.length?utils.status.show(_("track-empty-not-saving")):DB.addTrack(I,w,e),document.getElementById("btn-start-stop").className="recommend big",document.getElementById("btn-start-stop").textContent=_("start")}function s(e){if(e.coords&&e.coords.latitude&&e.coords.longitude){var t=e.coords,n=(new Date,t.speed);lat=t.latitude.toFixed(6),lon=t.longitude.toFixed(6);{var o=t.altitude,a=new Date(e.timestamp).toISOString(),r=t.accuracy.toFixed(0),i=t.altitudeAccuracy.toFixed(0);t.heading.toFixed(0)}(-200>o||0===o&&0===i)&&(o=null);var s=Tracks.getDistance(lat,lon);V=Tracks.getDuration(e.timestamp),HomeView.updateInfos(e,s);var c={latitude:lat,longitude:lon,altitude:o,date:a,speed:n,accuracy:r,vertAccuracy:i};Tracks.addNode(c,s,V)}}function c(){}function l(e){if(R=e,k(e),e.screen){var t=window.navigator.requestWakeLock("screen");window.addEventListener("unload",function(){t.unlock()})}}function d(e){console.log("__getConfigError ",e)}function u(e,t){R[e]=t,DB.updateConfig(m,g,e,t)}function m(){console.log("YES !"),DB.getConfig(l,d)}function g(e){console.log("NO !",e)}function f(e){console.log("inChecked",e),e?(W=window.navigator.requestWakeLock("screen"),window.addEventListener("unload",function(){W.unlock()})):window.navigator.requestWakeLock("screen").unlock()}function p(e){R.language=e}function h(e){R.distance=e}function v(e){R.speed=e}function y(e){R.position=e}function k(e){for(var t=0;t<Object.keys(e).length;t++){var n=Object.keys(e)[t];"screen"===n?Config.change("SCREEN_KEEP_ALIVE",e[n]):"language"===n||("distance"===n?Config.change("USER_DISTANCE",e[n]):"speed"===n?Config.change("USER_SPEED",e[n]):"position"===n&&Config.change("USER_POSITION_FORMAT",e[n]))}Config.CONFIG=e,console.log("Config.CONFIG",Config.CONFIG);var o=Config.userSmallDistance(null);document.getElementById("home-acc").innerHTML="&#177; "+o.v,document.getElementById("acc-unit").innerHTML="("+o.u+")";var o=Config.userSmallDistance(null);document.getElementById("home-alt").innerHTML=o.v,document.getElementById("alt-unit").innerHTML="("+o.u+")";var o=Config.userSmallDistance(null);document.getElementById("home-dist").innerHTML=o.v,document.getElementById("dist-unit").innerHTML="("+o.u+")";var o=Config.userSpeed(null);document.getElementById("home-speed").innerHTML=o.v,document.getElementById("speed-unit").innerHTML="("+o.u+")",document.getElementById("screen").checked=e.screen,document.getElementById("language").value=e.language,document.getElementById("distance").value=e.distance,document.getElementById("speed").value=e.speed,document.getElementById("position").value=e.position
}function I(e){utils.status.show(_("track-saved",{inEvent:e}))}function w(e){utils.status.show(e)}function C(){TracksView.reset(),DB.getTracks(E,S)}function E(e){console.log("inTracks to display are",e),TracksView.display(e,b)}function S(){}function b(e){console.log("inTrack display: ",e),X=e,TrackView.display(e,M)}function T(){DB.deleteTrack(L,B,X),console.log("delete track: ",X)}function L(){TracksView.reset(),C(),utils.status.show(_("track-delete-success",{name:X.name}))}function B(){utils.status.show(_("track-delete-failure",{name:X.name}))}function M(e){console.log("saving inTrack in Controller",e),DB.saveMap(x,D,e)}function x(){}function D(){}function H(e){Y=e}function q(){return X.name}function N(e){X.name=e,console.log("track name is now ",X.name),DB.updateTrack(F,O,X)}function F(){TrackView.updateName(X.name),document.getElementById("views").showCard(4),utils.status.show(_("track-rename-success",{name:X.name}))}function O(){utils.status.show(_("track-rename-failure"))}function P(e,t,n){if(e||t){if(e)var o=ExportTrack.toGPX(X);if(t){ExportTrack.toSummary(X)}}if("email"===n)console.log("sharing on email"),Share.toEmail(X,o);else if("twitter"===n)console.log("sharing on twitter");else if("local"===n){var a=X.name.replace(/[:.-]/g,"")+".gpx";console.log("sharing on local",a),Share.toLocal(o,a,A,G)}else console.log("nothind to be sharing on ??")}function A(e){utils.status.show(e)}function G(e){utils.status.show(e)}function j(){DB.addTrack(I,w,testdata)}var R,U,W,V,X,z=!1,Y=!1;return{importForDev:j,init:e,toggleWatch:r,stopWatch:i,displayTracks:C,deleteTrack:T,savingSettings:u,toggleScreen:f,changeLanguage:p,changeDistance:h,changeSpeed:v,changePosition:y,flippingTrack:H,getTrackName:q,renameTrack:N,shareTrack:P}}(),RunBikeHike=function(){document.addEventListener("DOMComponentsLoaded",function(){var e=document.getElementById("views");e.showCard(1);document.webL10n.get;Controller.init()})}();